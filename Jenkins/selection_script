pipeline {
    agent any

    // Step 1: Parameters
    parameters {
        string(name: 'FOLDER_NAME', defaultValue: 'NA', description: 'Folder name if needed for script')
        choice(
            name: 'SCRIPT_TO_RUN',
            choices: ['Select a script first'], // will be updated dynamically in Active Choices plugin
            description: 'Select the script you want to execute'
        )
    }

    stages {
        stage('Checkout SCM') {
            steps {
                echo "Checking out repository..."
                checkout scm
            }
        }

        stage('List Scripts in Jenkins Folder') {
            steps {
                script {
                    // List files in Jenkins folder
                    def scriptDir = "${pwd()}/Jenkins"
                    def files = []
                    if (fileExists(scriptDir)) {
                        files = sh(
                            script: "ls -1 ${scriptDir}",
                            returnStdout: true
                        ).trim().split("\n")
                    }
                    
                    echo "Available scripts in Jenkins/: ${files}"

                    // Fail if no scripts found
                    if (files.size() == 0) {
                        error "No scripts found in Jenkins/ folder!"
                    }

                    // For demonstration, you can print or select dynamically
                    // In Active Choices plugin, this list can populate a dropdown
                }
            }
        }

        stage('Run Selected Script') {
            steps {
                script {
                    // Ensure user selected a script
                    if (params.SCRIPT_TO_RUN == 'Select a script first') {
                        error "No script selected! Aborting..."
                    }

                    echo "Running script: ${params.SCRIPT_TO_RUN}"

                    // Run the script with error highlighting
                    def status = sh(
                        script: "bash Jenkins/${params.SCRIPT_TO_RUN} ${params.FOLDER_NAME}",
                        returnStatus: true
                    )

                    if (status != 0) {
                        echo "\033[31mERROR: Script ${params.SCRIPT_TO_RUN} failed with exit code ${status}\033[0m"
                        error "Stopping pipeline due to script failure."
                    } else {
                        echo "\033[32mSUCCESS: Script ${params.SCRIPT_TO_RUN} completed successfully.\033[0m"
                    }
                }
            }
        }
    }
}
